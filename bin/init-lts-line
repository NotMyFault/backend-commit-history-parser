#!/bin/bash
set -euo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

if [ $# -ne 1 ]; then
  echo "Usage: $1 <baseline_version>" >&2
  exit 1
fi

baseline=$1

# Make tagged commit part of the release branch
branch_name="stable-${baseline}"
git checkout -b $branch_name jenkins-${baseline}

# Update versions
mvn -q versions:set -DnewVersion=${baseline}.1-SNAPSHOT

# Point scm tags back to HEAD
sed -i 's/<tag>.*<\/tag>/<tag>HEAD<\/tag>/' pom.xml */pom.xml

echo "$branch_name" > packaging-ref.txt

git add pom.xml */pom.xml
git commit -m "Towards ${baseline}.1"

# Create dedicated packaging branch
packaging="$(mktemp -d /tmp/jenkins-lts-rc-packaging-XXXXXXXX)"
trap "rm -rf '$packaging'" EXIT
git clone git@github.com:jenkinsci/packaging.git "$packaging"
pushd "$packaging"
git checkout -b "$branch_name" master
git push -u origin "$branch_name"
popd

cat <<EOF

Remember to:
    Push the branch
    Push the backporting announcment
    Populate community calendar
EOF
