#!/bin/bash
set -euo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

if [ $# -ne 1 ]; then
  echo "Usage: $1 <baseline_version>" >&2
  exit 1
fi

baseline=$1

# Make tagged commit part of the release branch
branch_name="stable-${baseline}"
# Use first child of release commit as branch point (`[maven-release-plugin] prepare for next development iteration`)
git checkout -b $branch_name $(git log --reverse --ancestry-path --pretty=%H jenkins-${baseline}..master | head -1)

# Update versions
mvn -q versions:set-property -Dproperty=revision -DnewVersion=${baseline}.1

echo -Plts-release >> .mvn/maven.config

git add pom.xml .mvn/maven.config
git commit -m "Towards ${baseline}.1"

cat <<EOF

Remember to:
    Push the branch
    Create branch ${branch_name} for packaging and push it
    Push the backporting announcement
    Populate community calendar
EOF
